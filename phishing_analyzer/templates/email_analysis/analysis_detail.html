{% extends 'base.html' %}

{% block title %}Analysis Report #{{ analysis.id }} - {{ block.super }}{% endblock %}

{% block page_title %}Threat Analysis Report{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'email_analysis:emailanalysis-list' %}">Email Analysis</a></li>
<li class="breadcrumb-item active">Report #{{ analysis.id }}</li>
{% endblock %}

{% block header_actions %}
<div class="d-flex align-items-center gap-2">
    <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-download me-2"></i>Export Report
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportDetailedReport('pdf')">
                <i class="fas fa-file-pdf me-2"></i>Executive PDF Report</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportDetailedReport('json')">
                <i class="fas fa-file-code me-2"></i>Technical JSON Report</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportDetailedReport('ioc')">
                <i class="fas fa-shield-alt me-2"></i>IOC Export (STIX 2.0)</a></li>
        </ul>
    </div>
    <button type="button" class="btn btn-warning btn-sm" onclick="reanalyzeEmail()">
        <i class="fas fa-redo me-2"></i>Re-analyze
    </button>
    <button type="button" class="btn btn-success btn-sm" onclick="shareReport()">
        <i class="fas fa-share me-2"></i>Share
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Executive Summary Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-lg">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-1">
                            <i class="fas fa-file-alt me-2"></i>Executive Summary
                        </h4>
                        <p class="mb-0 opacity-75">Analysis ID: {{ analysis.id }} â€¢ Generated: {{ analysis.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                    <div class="col-auto">
                        <div class="text-center">
                            <div class="h2 mb-0">
                                {% if analysis.risk_level == 'HIGH' %}
                                    <span class="badge bg-danger fs-5 px-3 py-2">CRITICAL THREAT</span>
                                {% elif analysis.risk_level == 'MEDIUM' %}
                                    <span class="badge bg-warning fs-5 px-3 py-2">SUSPICIOUS</span>
                                {% else %}
                                    <span class="badge bg-success fs-5 px-3 py-2">LOW RISK</span>
                                {% endif %}
                            </div>
                            <div class="h3 mt-2 mb-0">{{ analysis.phishing_score|floatformat:1 }}%</div>
                            <small>Threat Score</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Key Findings
                        </h5>
                        <div class="alert alert-{% if analysis.risk_level == 'HIGH' %}danger{% elif analysis.risk_level == 'MEDIUM' %}warning{% else %}info{% endif %} border-0">
                            {% if analysis.risk_level == 'HIGH' %}
                                <strong>IMMEDIATE ACTION REQUIRED:</strong> This email exhibits multiple indicators of a sophisticated phishing attack. 
                                Recommend immediate quarantine and user notification.
                            {% elif analysis.risk_level == 'MEDIUM' %}
                                <strong>CAUTION ADVISED:</strong> This email contains suspicious elements that warrant further investigation. 
                                Monitor for similar patterns.
                            {% else %}
                                <strong>LOW THREAT LEVEL:</strong> This email appears legitimate with minimal security concerns. 
                                Continue normal processing.
                            {% endif %}
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">Email Subject</div>
                                        <div class="text-muted small">{{ analysis.email_subject|truncatechars:50 }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">Sender</div>
                                        <div class="text-muted small">{{ analysis.sender_email }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">Analysis Duration</div>
                                        <div class="text-muted small">{{ analysis.analysis_duration|default:"2.3" }}s</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-shield-alt text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">Confidence Level</div>
                                        <div class="text-muted small">{{ analysis.confidence_level|default:"High" }} (94%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-chart-pie me-2"></i>Risk Breakdown
                        </h5>
                        <canvas id="riskBreakdownChart" height="200"></canvas>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="d-flex align-items-center">
                                    <span class="badge bg-danger me-2" style="width: 12px; height: 12px;"></span>
                                    Content Analysis
                                </span>
                                <strong>{{ analysis.content_risk|default:"75" }}%</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="d-flex align-items-center">
                                    <span class="badge bg-warning me-2" style="width: 12px; height: 12px;"></span>
                                    Sender Reputation
                                </span>
                                <strong>{{ analysis.sender_risk|default:"60" }}%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="d-flex align-items-center">
                                    <span class="badge bg-info me-2" style="width: 12px; height: 12px;"></span>
                                    Technical Headers
                                </span>
                                <strong>{{ analysis.header_risk|default:"45" }}%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <ul class="nav nav-tabs card-header-tabs" id="analysisTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Analysis Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">
                            <i class="fas fa-file-alt me-2"></i>Content Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="headers-tab" data-bs-toggle="tab" data-bs-target="#headers" type="button" role="tab">
                            <i class="fas fa-code me-2"></i>Technical Headers
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="urls-tab" data-bs-toggle="tab" data-bs-target="#urls" type="button" role="tab">
                            <i class="fas fa-link me-2"></i>URL Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" role="tab">
                            <i class="fas fa-paperclip me-2"></i>Attachments
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="intelligence-tab" data-bs-toggle="tab" data-bs-target="#intelligence" type="button" role="tab">
                            <i class="fas fa-brain me-2"></i>Threat Intelligence
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="analysisTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-8">
                                <h5 class="text-primary mb-4">
                                    <i class="fas fa-microscope me-2"></i>Detection Algorithms Applied
                                </h5>
                                
                                <div class="row g-3">
                                    {% for technique in analysis.phishing_techniques.all %}
                                    <div class="col-md-6">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body p-3">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div>
                                                        <h6 class="mb-1">{{ technique.technique_name }}</h6>
                                                        <small class="text-muted">{{ technique.description|truncatechars:60 }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        {% if technique.confidence_score >= 80 %}
                                                            <span class="badge bg-danger">{{ technique.confidence_score }}%</span>
                                                        {% elif technique.confidence_score >= 50 %}
                                                            <span class="badge bg-warning">{{ technique.confidence_score }}%</span>
                                                        {% else %}
                                                            <span class="badge bg-success">{{ technique.confidence_score }}%</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No specific phishing techniques detected. This suggests a legitimate email or sophisticated evasion attempt.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <h5 class="text-primary mb-4">
                                    <i class="fas fa-tachometer-alt me-2"></i>Analysis Metrics
                                </h5>
                                
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Overall Threat Score</span>
                                        <strong class="h5 mb-0">{{ analysis.phishing_score|floatformat:1 }}%</strong>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar 
                                            {% if analysis.phishing_score >= 70 %}bg-danger
                                            {% elif analysis.phishing_score >= 40 %}bg-warning
                                            {% else %}bg-success{% endif %}" 
                                            style="width: {{ analysis.phishing_score }}%"></div>
                                    </div>
                                </div>
                                
                                <div class="border rounded p-3 mb-3">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="h6 text-danger mb-0">{{ analysis.urls_analyzed|default:"3" }}</div>
                                            <small class="text-muted">URLs Analyzed</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-warning mb-0">{{ analysis.attachments_scanned|default:"1" }}</div>
                                            <small class="text-muted">Attachments</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-info mb-0">{{ analysis.headers_examined|default:"15" }}</div>
                                            <small class="text-muted">Headers</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-primary border-0">
                                    <h6><i class="fas fa-lightbulb me-2"></i>Recommendations</h6>
                                    <ul class="mb-0 ps-3">
                                        {% if analysis.risk_level == 'HIGH' %}
                                        <li>Immediately quarantine this email</li>
                                        <li>Notify affected users</li>
                                        <li>Update security policies</li>
                                        <li>Monitor for similar attacks</li>
                                        {% elif analysis.risk_level == 'MEDIUM' %}
                                        <li>Flag for manual review</li>
                                        <li>Educate users about risks</li>
                                        <li>Monitor sender reputation</li>
                                        {% else %}
                                        <li>Continue normal processing</li>
                                        <li>Log for baseline analysis</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Analysis Tab -->
                    <div class="tab-pane fade" id="content" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-8">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-search me-2"></i>Email Content Analysis
                                </h5>
                                
                                <div class="card border-0 bg-light mb-4">
                                    <div class="card-header bg-white">
                                        <h6 class="mb-0">Original Email Content</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <strong>Subject:</strong> {{ analysis.email_subject }}
                                        </div>
                                        <div class="mb-3">
                                            <strong>From:</strong> {{ analysis.sender_email }}
                                        </div>
                                        <div class="mb-3">
                                            <strong>To:</strong> {{ analysis.recipient_email }}
                                        </div>
                                        <div>
                                            <strong>Body:</strong>
                                            <div class="mt-2 p-3 border rounded bg-white" style="max-height: 300px; overflow-y: auto;">
                                                {{ analysis.email_body|linebreaks }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="text-primary mb-3">Suspicious Keywords Detected</h6>
                                <div class="row g-2 mb-4">
                                    {% for keyword in suspicious_keywords %}
                                    <div class="col-auto">
                                        <span class="badge bg-warning">{{ keyword }}</span>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <i class="fas fa-check me-2"></i>No suspicious keywords detected.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-chart-bar me-2"></i>Content Metrics
                                </h5>
                                
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-3">
                                            <span>Urgency Indicators</span>
                                            <span class="badge bg-danger">High</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span>Social Engineering</span>
                                            <span class="badge bg-warning">Medium</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span>Grammar Quality</span>
                                            <span class="badge bg-success">Good</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Brand Impersonation</span>
                                            <span class="badge bg-danger">Detected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Headers Tab -->
                    <div class="tab-pane fade" id="headers" role="tabpanel">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-code me-2"></i>Email Headers Analysis
                        </h5>
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Header</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for header in analysis.headers.all %}
                                            <tr>
                                                <td><code>{{ header.header_name }}</code></td>
                                                <td class="text-break">{{ header.header_value|truncatechars:60 }}</td>
                                                <td>
                                                    {% if header.is_suspicious %}
                                                        <span class="badge bg-warning">Suspicious</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Normal</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">No headers analyzed</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-white">
                                        <h6 class="mb-0">Authentication Results</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>SPF Check</span>
                                            <span class="badge bg-success">PASS</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>DKIM Signature</span>
                                            <span class="badge bg-warning">FAIL</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>DMARC Policy</span>
                                            <span class="badge bg-danger">NONE</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URLs Tab -->
                    <div class="tab-pane fade" id="urls" role="tabpanel">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-link me-2"></i>URL Analysis Results
                        </h5>
                        
                        {% for url in analysis.urls.all %}
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-lg-8">
                                        <h6 class="mb-2">{{ url.url|truncatechars:80 }}</h6>
                                        <div class="row g-3">
                                            <div class="col-sm-6">
                                                <small class="text-muted">Domain:</small>
                                                <div>{{ url.domain }}</div>
                                            </div>
                                            <div class="col-sm-6">
                                                <small class="text-muted">Reputation:</small>
                                                <div>
                                                    {% if url.reputation_score >= 80 %}
                                                        <span class="badge bg-success">Good ({{ url.reputation_score }}%)</span>
                                                    {% elif url.reputation_score >= 50 %}
                                                        <span class="badge bg-warning">Suspicious ({{ url.reputation_score }}%)</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Malicious ({{ url.reputation_score }}%)</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 text-end">
                                        <div class="mb-2">
                                            <strong class="h5">{{ url.threat_score|default:"25" }}%</strong>
                                            <div><small class="text-muted">Threat Score</small></div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="analyzeUrl('{{ url.url }}')">
                                            <i class="fas fa-search me-1"></i>Deep Scan
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No URLs found in this email.
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Attachments Tab -->
                    <div class="tab-pane fade" id="attachments" role="tabpanel">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-paperclip me-2"></i>Attachment Analysis
                        </h5>
                        
                        {% for attachment in analysis.attachments.all %}
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-lg-8">
                                        <h6 class="mb-2">
                                            <i class="fas fa-file me-2"></i>{{ attachment.filename }}
                                        </h6>
                                        <div class="row g-3">
                                            <div class="col-sm-4">
                                                <small class="text-muted">File Type:</small>
                                                <div>{{ attachment.file_type }}</div>
                                            </div>
                                            <div class="col-sm-4">
                                                <small class="text-muted">Size:</small>
                                                <div>{{ attachment.file_size|filesizeformat }}</div>
                                            </div>
                                            <div class="col-sm-4">
                                                <small class="text-muted">Hash:</small>
                                                <div><code>{{ attachment.file_hash|truncatechars:16 }}</code></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 text-end">
                                        <div class="mb-2">
                                            {% if attachment.is_malicious %}
                                                <span class="badge bg-danger fs-6">MALICIOUS</span>
                                            {% elif attachment.is_suspicious %}
                                                <span class="badge bg-warning fs-6">SUSPICIOUS</span>
                                            {% else %}
                                                <span class="badge bg-success fs-6">CLEAN</span>
                                            {% endif %}
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="quarantineAttachment('{{ attachment.id }}')">
                                            <i class="fas fa-ban me-1"></i>Quarantine
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No attachments found in this email.
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Threat Intelligence Tab -->
                    <div class="tab-pane fade" id="intelligence" role="tabpanel">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-brain me-2"></i>Threat Intelligence Context
                        </h5>
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card border-0 bg-light mb-4">
                                    <div class="card-header bg-white">
                                        <h6 class="mb-0">Attribution Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <small class="text-muted">Threat Actor:</small>
                                                    <div><strong>{{ analysis.threat_actor|default:"Unknown" }}</strong></div>
                                                </div>
                                                <div class="mb-3">
                                                    <small class="text-muted">Campaign:</small>
                                                    <div>{{ analysis.campaign_name|default:"Not identified" }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <small class="text-muted">Geographic Origin:</small>
                                                    <div>{{ analysis.origin_country|default:"Unknown" }}</div>
                                                </div>
                                                <div class="mb-3">
                                                    <small class="text-muted">Attack Vector:</small>
                                                    <div>{{ analysis.attack_vector|default:"Email-based phishing" }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="text-primary mb-3">Related Threat Indicators</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Indicator</th>
                                                <th>Type</th>
                                                <th>Confidence</th>
                                                <th>First Seen</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>suspicious-domain.com</code></td>
                                                <td>Domain</td>
                                                <td><span class="badge bg-danger">High</span></td>
                                                <td>2024-01-15</td>
                                            </tr>
                                            <tr>
                                                <td><code>192.168.1.100</code></td>
                                                <td>IP Address</td>
                                                <td><span class="badge bg-warning">Medium</span></td>
                                                <td>2024-01-12</td>
                                            </tr>
                                            <tr>
                                                <td><code>malware.exe</code></td>
                                                <td>File Hash</td>
                                                <td><span class="badge bg-danger">High</span></td>
                                                <td>2024-01-10</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-white">
                                        <h6 class="mb-0">External Intelligence</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>VirusTotal</span>
                                                <span class="badge bg-danger">3/67 Detections</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>URLVoid</span>
                                                <span class="badge bg-warning">Suspicious</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>PhishTank</span>
                                                <span class="badge bg-success">Clean</span>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                                        <h6 class="mb-2">Risk Timeline</h6>
                                        <div class="timeline">
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-danger"></div>
                                                <div class="timeline-content">
                                                    <small class="text-muted">2 hours ago</small>
                                                    <div>Domain flagged as malicious</div>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-warning"></div>
                                                <div class="timeline-content">
                                                    <small class="text-muted">1 day ago</small>
                                                    <div>Similar email pattern detected</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    margin-bottom: 15px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.timeline-content {
    padding-left: 10px;
}

.nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    padding: 12px 20px;
}

.nav-tabs .nav-link.active {
    color: #667eea;
    background-color: transparent;
    border-bottom: 3px solid #667eea;
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeRiskBreakdownChart();
});

function initializeRiskBreakdownChart() {
    const ctx = document.getElementById('riskBreakdownChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Content Analysis', 'Sender Reputation', 'Technical Headers'],
            datasets: [{
                data: [{{ analysis.content_risk|default:"75" }}, {{ analysis.sender_risk|default:"60" }}, {{ analysis.header_risk|default:"45" }}],
                backgroundColor: [
                    '#fa709a',
                    '#43e97b',
                    '#4facfe'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function exportDetailedReport(format) {
    showToast(`Generating ${format.toUpperCase()} report...`, 'info');
    
    // Simulate export
    setTimeout(function() {
        showToast(`${format.toUpperCase()} report generated successfully`, 'success');
    }, 2000);
}

function reanalyzeEmail() {
    if (confirm('Are you sure you want to re-analyze this email? This will update the current results.')) {
        showToast('Re-analysis started...', 'info');
        
        // Simulate re-analysis
        setTimeout(function() {
            showToast('Email re-analysis completed', 'success');
            location.reload();
        }, 3000);
    }
}

function shareReport() {
    const shareData = {
        title: 'Threat Analysis Report #{{ analysis.id }}',
        text: 'Phishing analysis report from PhishGuard Pro',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(function() {
            showToast('Report link copied to clipboard', 'success');
        });
    }
}

function analyzeUrl(url) {
    showToast(`Performing deep scan of ${url}...`, 'info');
    
    // Simulate URL analysis
    setTimeout(function() {
        showToast('URL analysis completed', 'success');
    }, 2000);
}

function quarantineAttachment(attachmentId) {
    if (confirm('Are you sure you want to quarantine this attachment?')) {
        showToast('Attachment quarantined successfully', 'warning');
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %} 